{% load static %}
<style>
    iframe.drawio-editor
    {
        position: fixed;
        top: 0;
        left: 0;
        bottom: 0;
        right: 0;
        width: 100%;
        height: 100%;
        background: white;
        z-index: 10000;
    }
</style>
<script type="text/javascript">

// DrawioEditor class: a simple wrapper around the draw.io editor

class DrawioEditor
{
    constructor(elementId, eventName=null)
    {
        this.element = document.getElementById(elementId); // the image element

        if (this.element == null) {
            console.error("Drawio: Element not found:", elementId);
            return;
        }


        this.drawio = null; // will hold the contentWindow of the iframe
        this.iframe = null; // the iframe element

        if (eventName == null) {
            const name = this._getFlag('event');
            if (name) {
                eventName = name;
            } else {
                eventName = 'dlbclick';
            }
        }
        this._eventName = eventName;

        // Set up event handlers
        this.element.addEventListener(this._eventName, () => this.activate());
    }

    _getTarget(suffix)
    {
        // Check data-target to find target element
        const targetId = this.element.getAttribute('data-' + suffix);
        console.log('drawio: target"' + suffix +'" is:', targetId);

        if (targetId == null) {
            return null;
        }

        if (targetId == '@self') {
            return this.element;
        }

        if (targetId[0] == '#') {
            return document.getElementById(targetId.slice(1));
        }

        if (targetId[0] == '.') {
            const lst = document.getElementsByClassName(targetId.slice(1));
            if (lst.length > 0) {
                return lst[0];
            }
        }

        console.warning("drawio: invalid target:", targetId);
        return null;
    }

    _getFlag(suffix)
    {
        // Check data-flag to find target element
        const flag = this.element.getAttribute('data-' + suffix);
        return flag;
    }

    activate()
    {
        const url = 'https://embed.diagrams.net/?embed=1&ui=atlas&spin=1&modified=unsavedChanges&proto=json';

        const iframe = document.createElement('iframe');
        iframe.setAttribute('frameborder', '0');
        iframe.setAttribute('class', 'drawio-editor');

        iframe.close = () => {
            window.removeEventListener('message', this.receive);
            document.body.removeChild(iframe);
            this.drawio = null;
            this.iframe = null;
        };

        if (this.drawio == null || this.drawio.closed) {

            window.addEventListener('message', (evt) => this.receive(evt));

            iframe.setAttribute('src', url);
            document.body.appendChild(iframe);
            this.drawio = iframe.contentWindow;
            this.iframe = iframe;

        } else {
            this.drawio.focus();
        }
    }


    // Protocol implementation:
    _onInit(msg)
    {
        this.drawio.postMessage(JSON.stringify({
            action: 'load', xmlpng: this.element.getAttribute('src')
        }), '*');
    }

    _onSave(msg)
    {
        this.drawio.postMessage(JSON.stringify({
            action: 'export', format: 'xmlpng', spinKey: 'saving'
        }), '*');
    }


    _onExit(msg)
    {
        this.iframe.close();
    }

    _onExport(msg)
    {
        this.element.setAttribute('src', msg.data);

        const storage = this._getTarget('storage');
        if (storage) {
            storage.value = msg.data;
        }

        const xml = this._getTarget('xml');
        if (xml) {
            xml.value = msg.xml;
        }

        // Round the size:
        const width = Math.round(msg.bounds.width);
        const height = Math.round(msg.bounds.height);

        const dwidth = this._getTarget('width');
        if (dwidth) {
            dwidth.value = width;
        }

        const dheight = this._getTarget('height');
        if (dheight) {
            dheight.value = height;
        }

        if (this._getFlag('update-size')) {
            this.element.style.width = width + 'px';
            this.element.style.height = height + 'px';
        }
        // Auto exit:
        this._onExit(msg);
    }

    _states = {
        'init': this._onInit,
        'save': this._onSave,
        'export': this._onExport,
        'exit': this._onExit
    };

    // protocol router
    // doc https://www.drawio.com/doc/faq/embed-mode
    receive(evt)
    {
        if (evt.data.length > 0 && evt.source == this.drawio) {
            const msg = JSON.parse(evt.data);
            if (msg.event in this._states) {
                this._states[msg.event].call(this, msg);
            } else {
                console.log('DrawIO: Unknown message:', msg);
            }

        }
    }

}

if (jQuery && jQuery.fn && jQuery.fn.drawio == undefined) {
    jQuery.fn.drawio = function() {
        this.each(function() {
           this.drawio = new DrawioEditor(this.id);
        });
    }
}

// Initialize the editor:
document.addEventListener('DOMContentLoaded', function(){
    new DrawioEditor('img-{{widget.attrs.id}}');
});;

</script>

<div class="drawio-editor" id="drawio-editor">
<img class="drawio" id="img-{{widget.attrs.id}}"
     {% if not widget.value %}
        src="{% static "admin/media/drawio_edit.svg" %}"
        width="50%" height="auto"
     {% else %}
        src="{{widget.value}}"
    {% endif %}
    title="Double click to edit"
    data-storage="#{{widget.attrs.id}}"
    data-event="dblclick"
    data-update-size="true"

    data-width="#id_width"
    data-height="#id_height"
    data-xml="#id_xml_content"
/>
<input type="hidden" id="{{widget.attrs.id}}" name="{{widget.name}}" value="{{widget.value}}">
</div>
